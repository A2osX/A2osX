NEW
  AUTO 3,1
				.LIST OFF
				.OP	65C02
				.OR	$2000
				.TF lib/libgui
*--------------------------------------
				.INB inc/macros.i
				.INB inc/a2osx.i
				.INB inc/a2osx.api.i
				.INB inc/kernel.i
				.INB inc/io.i
				.INB inc/mli.i
				.INB inc/mli.e.i
				.INB inc/gfx.i
				.INB inc/xy.i
				.INB inc/libgui.i
*--------------------------------------
WND.MAX			.EQ 64
MENU.MAX		.EQ 4
*--------------------------------------
				.MA SWAP16
				lda ]1
				ldx ]2
				stx ]1
				sta ]2
				lda ]1+1
				ldx ]2+1
				stx ]1+1
				sta ]2+1
				.EM

				.MA NOT16
				sec
				lda #0
				sbc ]1
				sta ]1
				lda #0
				sbc ]1+1
				sta ]1+1
				.EM

				.MA SCMPAX
				sec
				sbc ]1
				txa
				sbc ]1+1
				bvc :1
				eor #$80
:1				.EQ *
				.EM

				.MA SCMPYA
				cpy ]1
				sbc ]1+1
				bvc :1
				eor #$80
:1				.EQ *
				.EM

				.MA STYAIFGTR
				tax
				>SCMPYA ]1
				bmi :1

				sty ]1
				stx ]1+1
:1				.EQ *
				.EM

				.MA STYAIFLWR
				tax
				>SCMPYA ]1
				bpl :1

				sty ]1
				stx ]1+1
:1				.EQ *
				.EM
*--------------------------------------
				.DUMMY
				.OR ZPLIB
ZPpWND			.BS 2
ZPpOBJ			.BS 2
ZPpBM			.BS 2

ZPpClipWND		.BS 2
ZPCBBufPtr		.BS 2

DX				.BS 2
DY				.BS 2
IE				.BS 2
INE				.BS 2

D				.BS 2
Counter			.BS 2

CLIP.TmpW		.EQ *
CLIP.Line.P1	.BS 1
CLIP.Line.P2	.BS 1

IY				.BS 1
bPTR			.BS 1

				.ED
*--------------------------------------
*			File Header (16 Bytes)
*--------------------------------------
CS.START		cld
				jmp (.1,x)
				.DA #$61				6502,Level 1 (65c02)
				.DA #2					BIN Layout Version 2
				.DA 0
				.DA CS.END
				.DA ID.END
				.DA 0
				.DA 0
*--------------------------------------
* Relocation Table
*--------------------------------------
.1				.DA LIB.LOAD
				.DA LIB.UNLOAD
				.DA PTR.Set
				.DA PTR.SetPos
				.DA PTR.Hide
				.DA PTR.Show
				.DA PTR.Update
				.DA DRAW.Line
				.DA DRAW.Fill
				.DA DRAW.BitMap
				.DA DRAW.Text
				.DA OBJ.SetProp
				.DA OBJ.GetProp
				.DA WND.New
				.DA WND.Destroy
				.DA WND.Show
				.DA WND.ShowAll
				.DA WND.SetMBar
				.DA MSG.Get
				.DA MBOX.MsgBox
				.DA MENU.New
				.DA MENU.Show
				.DA FON.GetProps
				.DA FON.GetTextW
				.DA FON.GetTextSize
				.DA WND.Get
				.DA WND.AddChild
				.DA PANE.New
				.DA WND.Set
*--------------------------------------
L.DEVNAME.GFX	.DA DEVNAME.GFX
L.DEVNAME.MOUSE	.DA DEVNAME.MOUSE
L.fSYS			.DA fSYS
L.fSYSB			.DA fSYSB
L.fFIXED		.DA fFIXED
L.IOCTL			.DA IOCTL
L.DCB.GFX		.DA DCB.GFX
L.MouseClamp	.DA MouseClamp
L.MSG			.DA MSG
L.MSG.XY		.DA MSG+S.MSG.S
L.CB.Ptr		.DA CB.Ptr
L.CB.Cache		.DA CB.Cache
L.CLIP.Cache	.DA CLIP.Cache
L.TEXTBUF		.DA TEXTBUF
*--------------------------------------
L.BMs			.EQ *-2
L.BM.Apple		.DA BM.Apple
L.BM.Close		.DA BM.Close
L.BM.Max		.DA BM.Max
L.BM.Min		.DA BM.Min
L.BM.Left		.DA BM.Left
L.BM.Right		.DA BM.Right
L.BM.Up			.DA BM.Up
L.BM.Down		.DA BM.Down
L.BM.Info		.DA BM.Info
*--------------------------------------
L.BUT.Labels	.DA BUT.L.OK
				.DA BUT.L.CANCEL
				.DA BUT.L.RETRY
				.DA BUT.L.IGNORE
				.DA BUT.L.YES
				.DA BUT.L.NO
*--------------------------------------
L.PATs			.DA PAT.bgWND1
*--------------------------------------
L.PTR.SaveBuf	.DA PTR.SaveBuf
L.PTRs			.DA PTR.Arrow
				.DA PTR.Move
				.DA PTR.ResizeX
				.DA PTR.ResizeY
				.DA PTR.ResizeXY1
				.DA PTR.ResizeXY2
				.DA PTR.Cross
				.DA PTR.Text
				.DA PTR.Wait1
				.DA PTR.Wait2
				.DA PTR.Wait3
				.DA PTR.Wait4
				.DA PTR.Wait5
				.DA PTR.Wait6
*--------------------------------------
J.Clip			.DA CLIP.Point			SETPIXEL
				.DA CLIP.Point			GETPIXEL
				.DA CLIP.HLine			HLINE
				.DA CLIP.VLine			VLINE
				.DA CLIP.Rectangle		FILLRECT
				.DA CLIP.BitBlt			BITBLT
				.DA CLIP.Rectangle		GETRECTBUFSIZE
				.DA CLIP.Text			DRAWTEXT
				.DA CLIP.Text			GETTEXTSIZE
				.DA CLIP.Line			DRAWLINE
				.DA CLIP.BitBlt			DRAWTEXT2
*--------------------------------------
J.OBJ.fEnter	.DA WND.fEnter
				.DA MBAR.fEnter
				.DA MENU.fEnter
				.DA BUT.fEnter
				.DA TEXT.fEnter
				.DA BITMAP.fEnter
				.DA LABEL.fEnter
				.DA PANE.fEnter
*--------------------------------------
J.OBJ.fLeave	.DA WND.fLeave
				.DA MBAR.fLeave
				.DA MENU.fLeave
				.DA BUT.fLeave
				.DA TEXT.fLeave
				.DA BITMAP.fLeave
				.DA LABEL.fLeave
				.DA PANE.fLeave
*--------------------------------------
J.OBJ.fPaint	.DA WND.fPaint
				.DA MBAR.fPaint
				.DA MENU.fPaint
				.DA BUT.fPaint
				.DA TEXT.fPaint
				.DA BITMAP.fPaint
				.DA LABEL.fPaint
				.DA PANE.fPaint
*--------------------------------------
				.DA 0
*--------------------------------------
LIB.LOAD		lda LibCount
				bne .8

				jsr MOU.Init
*				bcs .9

				jsr WND.Init			setup CLIP.Screen
				bcs .9

				ldy hDevMouse
				beq .1

				jsr MOU.Setup			need CLIP.Screen
				bcs .9

.1				jsr PTR.Reset

				jsr PTR.Show

				jsr FON.Init
				bcs .9

				inc LibCount

.8				clc

.9				rts
*--------------------------------------
LIB.UNLOAD		dec LibCount
				bne .8

				jsr MOU.Quit

.8				clc
				rts
*--------------------------------------
SkipAPtr1		clc
				adc ZPPtr1
				sta ZPPtr1
				bcc .8

				inc ZPPtr1+1

.8				rts
*--------------------------------------
SkipStrZPtr1	ldy #$ff

.1				iny
				lda (ZPPtr1),y
				bne .1

				tya
				sec						\0
				adc ZPPtr1
				sta ZPPtr1
				bcc .8

				inc ZPPtr1+1

.8				rts
*--------------------------------------
SkipAPtr2		clc
				adc ZPPtr2
				sta ZPPtr2
				bcc .8

				inc ZPPtr2+1

.8				rts
*--------------------------------------
SkipStrZPtr2	ldy #$ff

.1				iny
				lda (ZPPtr2),y
				bne .1

				tya
				sec						\0
				adc ZPPtr2
				sta ZPPtr2
				bcc .8

				inc ZPPtr2+1

.8				rts
*--------------------------------------
				.INB usr/src/lib/libgui.s.bitmap
				.INB usr/src/lib/libgui.s.bm
				.INB usr/src/lib/libgui.s.but
				.INB usr/src/lib/libgui.s.cb
				.INB usr/src/lib/libgui.s.clip
*				.INB usr/src/lib/libgui.s.cur
				.INB usr/src/lib/libgui.s.draw
				.INB usr/src/lib/libgui.s.fon
				.INB usr/src/lib/libgui.s.label
				.INB usr/src/lib/libgui.s.mbar
				.INB usr/src/lib/libgui.s.mbox
				.INB usr/src/lib/libgui.s.menu
				.INB usr/src/lib/libgui.s.mou
				.INB usr/src/lib/libgui.s.msg
				.INB usr/src/lib/libgui.s.obj
				.INB usr/src/lib/libgui.s.pane
				.INB usr/src/lib/libgui.s.ptr
*				.INB usr/src/lib/libgui.s.sysbar
				.INB usr/src/lib/libgui.s.text
				.INB usr/src/lib/libgui.s.wnd
*--------------------------------------
CS.END			.EQ *
*--------------------------------------
				.INB usr/src/lib/libgui.g.bm
				.INB usr/src/lib/libgui.g.cur
				.INB usr/src/lib/libgui.g.fon
				.INB usr/src/lib/libgui.g.pat
				.INB usr/src/lib/libgui.g.ptr
*--------------------------------------
DEVNAME.GFX		.AZ "/dev/gfx"
DEVNAME.MOUSE	.AZ "/dev/mou1"
*--------------------------------------
fSYS			.AZ "/opt/gui/fonts/sysx7"
fSYSB			.AZ "/opt/gui/fonts/sysx7b"
fFIXED			.AZ "/opt/gui/fonts/term6x7"
*--------------------------------------
OBJ.SizeOf		.DA S.WND
				.DA 0
				.DA 0
				.DA S.BUT
				.DA S.TEXT
				.DA S.BITMAP
				.DA S.LABEL
				.DA S.PANE
*--------------------------------------
BUT.L.OK		.AZ "Ok"
BUT.L.CANCEL	.AZ "Cancel"
BUT.L.RETRY		.AZ "Retry"
BUT.L.IGNORE	.AZ "Ignore"
BUT.L.YES		.AZ "Yes"
BUT.L.NO		.AZ "No"
*--------------------------------------
CB.CmdLen		.DA #S.CB.Y1+1			SETPIXEL
				.DA #S.CB.Y1+1			GETPIXEL
				.DA #S.CB.Y2+1			HLINE
				.DA #S.CB.Y2+1			VLINE
				.DA #S.CB.pPat+1		FILLRECT
				.DA #S.CB.pSrc+1		BITBLT
				.DA #S.CB.pDst+1		GETRECTBUFSIZE
				.DA #S.CB.pTxt+1		DRAWTEXT
				.DA #S.CB.pTxt+1		GETTEXTW
*--------------------------------------
				.DA #S.CB.Y2+1			DRAWLINE
				.DA #S.CB.pSrc+1		DRAWTEXT2
*--------------------------------------
LibCount		.BS 1
hDevGFX			.BS 2
hDevMouse		.BS 2
*--------------------------------------
PAT.Buf			.BS 1					S.BM.F
				.DA #1					S.BM.RowBytes
				.DA 8					S.BM.W
				.DA 8					S.BM.H
				.DA 0					S.BM.MASK.OFS
				.BS 8					(data)
*--------------------------------------
IOCTL			.BS S.IOCTL
DCB.GFX			.BS S.DCB.GFX
*--------------------------------------
MSG				.BS S.MSG
*--------------------------------------
CB.Ptr			.DA #S.CB.CMD.BITBLT
				.BS 1					S.CB.OP
				.DA #S.CB.M.MONO
				.DA #0
				.BS S.CB-4
*--------------------------------------
pCBBuf			.BS 2
*--------------------------------------
CB.Cache		.BS S.CB
CLIP.Cache		.BS S.CB
CLIP.Screen		.BS S.RECT
CLIP.Rect		.BS S.RECT
*--------------------------------------
MENU.Stack.Owner	.BS 2
MENU.Stack.Idx	.BS 1
MENU.Stack.Cnt	.BS 1
MENU.Stack		.BS MENU.MAX*2
*--------------------------------------
WND.Screen		.BS 2
WND.Desktop		.BS 2
*--------------------------------------
KEYMOD.S.CTRL	.EQ 0
KEYMOD.S		.AZ "Ctrl-"
KEYMOD.S.OA		.EQ *-KEYMOD.S
				.DA #01,#'-',#0
KEYMOD.S.CA		.EQ *-KEYMOD.S
				.DA #02,#'-',#0
*--------------------------------------
MouseClamp		.EQ *					MOU.Setup
TEXTBUF			.BS 16					for composing HotKey strings
*--------------------------------------
* X mod 28 :   04  00  12  08  20  16      24
* Screen   : c1110000 c3322221 c5444433 c6666555
*--------------------------------------
PREFS.BestViewedX	.DA #$FC
PREFS.nBestViewedX	.DA #$03
*
PREFS.XMargin		.DA #4
PREFS.XSeparator	.DA #4
*
PREFS.MenuColor		.DA #C.WHITE
PREFS.SysBarColor	.DA #C.WHITE
PREFS.BorderColor	.DA #C.BLACK
PREFS.TBarColorA	.DA #C16.M.BLUE
PREFS.TBarColorI	.DA #C16.L.BLUE
PREFS.MBarColor		.DA #C.WHITE

PREFS.SBarColor		.DA #C.WHITE
*--------------------------------------
ID.END			.EQ *
*--------------------------------------
MAN
SAVE usr/src/lib/libgui.s
ASM
